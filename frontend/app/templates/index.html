{% extends "base.html" %}

{% block title %}Home - Giotto Color Sorter{% endblock %}

{% block extra_css %}
<style>
/* Stili per il modulo di aggiunta manuale */
.color-code {
    font-family: 'Courier New', monospace;
    font-weight: bold;
}

#temporaryListContainer .table {
    margin-bottom: 0;
}

#temporaryListContainer .table th {
    background-color: #f8f9fa;
    font-size: 0.85rem;
    font-weight: 600;
    border-bottom: 2px solid #dee2e6;
}

#temporaryListContainer .table td {
    font-size: 0.9rem;
    vertical-align: middle;
}

.cluster-badge {
    font-size: 0.8rem;
}

/* Migliora la visualizzazione dei form */
.form-label {
    font-weight: 600;
    font-size: 0.9rem;
}

.form-control, .form-select {
    font-size: 0.9rem;
}

/* Stili per i badge di tipo colore */
.badge {
    font-size: 0.75rem;
}

/* Animazioni per la lista temporanea */
#temporaryListContainer {
    transition: all 0.3s ease;
}

/* Hover effects per i bottoni */
.btn-outline-danger:hover {
    transform: scale(1.05);
    transition: transform 0.1s ease;
}

/* Migliora la leggibilità delle tabelle */
.table-responsive {
    border-radius: 0.375rem;
    overflow: hidden;
}

.table-sm th,
.table-sm td {
    padding: 0.5rem;
}

/* Stili specifici per i placeholder */
.form-control::placeholder {
    color: #6c757d;
    opacity: 0.8;
}

/* Miglioramenti per il JSON editor */
.json-editor {
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    line-height: 1.4;
}

/* Badge colorati per i tipi di lunghezza */
.badge.bg-primary {
    background-color: #0d6efd !important;
}

.badge.bg-success {
    background-color: #198754 !important;
}

/* Spacing migliorato per le card */
.card {
    border: 1px solid #dee2e6;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.card-header {
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}

/* Stili per tabella input veloce */
.bulk-input-table {
    background-color: #f8f9fa;
}

.bulk-input-table thead {
    background-color: #e9ecef;
}

.bulk-input-table .form-control {
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
}

.bulk-input-table .form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.bulk-input-table .form-control.is-valid {
    border-color: #198754;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='m2.3 6.73.8-.8-.8-.8L1.5 6l.8.73zm1.48-.5L1.5 4l-.8.8 1.28 1.23 3.2-3.2-.8-.8-2.4 2.4z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.bulk-input-table .form-control.is-warning {
    border-color: #ffc107;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23ffc107' d='M4 1L1 7h6L4 1z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.bulk-input-table .form-select {
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
}

.bulk-input-table .btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

.bulk-input-table tr:hover {
    background-color: #f1f3f4;
}

/* Stili per messaggi bulk */
.bulk-message {
    margin-bottom: 1rem;
    border-radius: 0.5rem;
}

.bulk-message small {
    margin: 0;
    font-weight: 500;
}

/* Highlight per paste multiplo */
.bulk-color-input.highlight-paste {
    background-color: #fff3cd !important;
    border-color: #ffc107 !important;
    animation: highlightFade 2s ease-out;
}

.bulk-input-table .form-select.highlight-paste {
    background-color: #d1ecf1 !important;
    border-color: #17a2b8 !important;
    animation: highlightFade 2s ease-out;
}

.bulk-input-table .auto-filled {
    position: relative;
}

.bulk-input-table .auto-filled::after {
    content: "🤖";
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.8rem;
    pointer-events: none;
}

@keyframes highlightFade {
    0% {
        background-color: #fff3cd;
        border-color: #ffc107;
    }
    100% {
        background-color: #ffffff;
        border-color: #ced4da;
    }
}

/* Miglioramenti per tooltips */
.bulk-input-table .form-control[title] {
    cursor: help;
}

.text-warning {
    font-size: 0.75rem;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="h2 mb-4">
            <i class="fas fa-palette me-2 text-primary"></i>
            Giotto Color Sorter
        </h1>
    </div>
</div>

<div class="row">
    <!-- Form Input Colori -->
    <div class="col-lg-8">
        <!-- Input Veloce Colori - Cabina 1 -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-industry me-2"></i>
                    Cabina 1 - Corto
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="cabin1StartCluster" class="form-label">Cluster di Partenza</label>
                        <select class="form-select" id="cabin1StartCluster">
                            <option value="">-- Automatico --</option>
                            <option value="Bianco">Bianco</option>
                            <option value="Nero">Nero</option>
                            <option value="Rosso">Rosso</option>
                            <option value="Blu">Blu</option>
                            <option value="Verde">Verde</option>
                            <option value="Giallo">Giallo</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="cabin1FirstColor" class="form-label">Primo Colore (opzionale)</label>
                        <input type="text" class="form-control" id="cabin1FirstColor" placeholder="es. RAL9005">
                        <div class="form-text">Primo colore del cluster</div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-12 d-flex align-items-end justify-content-between">
                        <div>
                            <button type="button" class="btn btn-outline-primary me-2" onclick="addBulkRow('cabin1')">
                                <i class="fas fa-plus me-2"></i>Aggiungi Riga
                            </button>
                            <button type="button" class="btn btn-outline-info me-2" onclick="fillDefaultTypes('cabin1')">
                                <i class="fas fa-magic me-2"></i>Auto-Tipo
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="clearBulkTable('cabin1')">
                                <i class="fas fa-broom me-2"></i>Pulisci Tabella
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-bordered bulk-input-table">
                        <thead>
                            <tr>
                                <th style="width: 35%;">Colore</th>
                                <th style="width: 30%;">Tipologia</th>
                                <th style="width: 20%;">Sequenza</th>
                                <th style="width: 15%;">Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="cabin1InputBody">
                            <!-- Le righe verranno aggiunte dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Input Veloce Colori - Cabina 2 -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-industry me-2"></i>
                    Cabina 2 - Lungo
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="cabin2StartCluster" class="form-label">Cluster di Partenza</label>
                        <select class="form-select" id="cabin2StartCluster">
                            <option value="">-- Automatico --</option>
                            <option value="Bianco">Bianco</option>
                            <option value="Nero">Nero</option>
                            <option value="Rosso">Rosso</option>
                            <option value="Blu">Blu</option>
                            <option value="Verde">Verde</option>
                            <option value="Giallo">Giallo</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="cabin2FirstColor" class="form-label">Primo Colore (opzionale)</label>
                        <input type="text" class="form-control" id="cabin2FirstColor" placeholder="es. RAL9005">
                        <div class="form-text">Primo colore del cluster</div>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-12 d-flex align-items-end justify-content-between">
                        <div>
                            <button type="button" class="btn btn-outline-primary me-2" onclick="addBulkRow('cabin2')">
                                <i class="fas fa-plus me-2"></i>Aggiungi Riga
                            </button>
                            <button type="button" class="btn btn-outline-info me-2" onclick="fillDefaultTypes('cabin2')">
                                <i class="fas fa-magic me-2"></i>Auto-Tipo
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="clearBulkTable('cabin2')">
                                <i class="fas fa-broom me-2"></i>Pulisci Tabella
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-bordered bulk-input-table">
                        <thead>
                            <tr>
                                <th style="width: 35%;">Colore</th>
                                <th style="width: 30%;">Tipologia</th>
                                <th style="width: 20%;">Sequenza</th>
                                <th style="width: 15%;">Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="cabin2InputBody">
                            <!-- Le righe verranno aggiunte dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Pulsante Ottimizzazione Globale -->
        <div class="card mb-4">
            <div class="card-body text-center">
                <div class="alert alert-info mb-3">
                    <small>
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>Tip:</strong> Puoi incollare dati in qualsiasi cella "Colore" delle tabelle in due formati:
                        <br><strong>Formato semplice (solo codici):</strong>
                        <br><code>RAL9005<br>RAL9001<br>RAL8005</code>
                        <br><strong>Formato CSV completo (Codice,Tipologia,Sequenza):</strong>
                        <br><code>RAL8005,R,1<br>RAL9001,E,1<br>RAL9004,E,2</code>
                        <br>Il sistema riconoscerà automaticamente il formato e compilerà tutti i campi!
                    </small>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <button type="button" class="btn btn-outline-primary btn-sm w-100" onclick="insertTestCodes()">
                                <i class="fas fa-flask me-2"></i>Test: Codici Semplici
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button type="button" class="btn btn-outline-success btn-sm w-100" onclick="insertTestCSV()">
                                <i class="fas fa-table me-2"></i>Test: Formato CSV
                            </button>
                        </div>
                    </div>
                </div>
                
                <button type="button" class="btn btn-warning btn-lg" onclick="processBothCabins()">
                    <i class="fas fa-cogs me-2"></i>
                    <span class="btn-text-bulk">Ottimizza Entrambe le Cabine</span>
                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                </button>
                <div class="form-text mt-2">Elabora i colori inseriti in entrambe le cabine</div>
            </div>
        </div>

        <!-- Lista Temporanea -->
        <div class="row mb-4" id="temporaryListContainer" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-clock me-2"></i>
                            Lista Colori da Ottimizzare
                            <span class="badge bg-dark ms-2" id="temporaryCount">0</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Codice Colore</th>
                                        <th>Tipo</th>
                                        <th>Cluster</th>
                                        <th>CH</th>
                                        <th>Lunghezza</th>
                                        <th>Seq</th>
                                        <th>Tipo Seq</th>
                                        <th>Azioni</th>
                                    </tr>
                                </thead>
                                <tbody id="temporaryListBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Caricamento JSON -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <button class="btn btn-link text-white p-0 text-decoration-none w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#jsonFormCollapse" aria-expanded="false" aria-controls="jsonFormCollapse">
                        <i class="fas fa-upload me-2"></i>
                        Carica Lista Colori (JSON)
                        <i class="fas fa-chevron-down float-end mt-1" id="jsonToggleIcon"></i>
                    </button>
                </h5>
            </div>
            <div class="collapse" id="jsonFormCollapse">
                <div class="card-body">
                    <form id="optimizationForm">
                    <div class="mb-3">
                        <label for="colorsJson" class="form-label">Lista Colori (formato JSON)</label>
                        <textarea class="form-control json-editor" id="colorsJson" name="colorsJson" rows="8" placeholder='[
  {
    "code": "RAL9005",
    "type": "R",
    "sequence": 1,
    "lunghezza_ordine": "corto",
    "CH": 25.5
  },
  {
    "code": "RAL1013",
    "type": "F",
    "sequence": 2,
    "lunghezza_ordine": "lungo",
    "CH": 30.2
  }
]'></textarea>
                        <div class="form-text">
                            Inserisci la lista colori in formato JSON. Ogni colore deve avere almeno i campi: code, type, lunghezza_ordine.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="startCluster" class="form-label">Cluster di Partenza (opzionale)</label>
                        <select class="form-select" id="startCluster" name="startCluster">
                            <option value="">-- Automatico --</option>
                            <option value="Bianco">Bianco</option>
                            <option value="Nero">Nero</option>
                            <option value="Rosso">Rosso</option>
                            <option value="Blu">Blu</option>
                            <option value="Verde">Verde</option>
                            <option value="Giallo">Giallo</option>
                        </select>
                        <div class="form-text">
                            Se non specificato, il sistema determinerà automaticamente il cluster di partenza ottimale.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="firstColor" class="form-label">Primo Colore del Cluster (opzionale)</label>
                        <input type="text" class="form-control" id="firstColor" name="firstColor" placeholder="es. RAL9005">
                        <div class="form-text">
                            Specifica il primo colore con cui iniziare il cluster. Deve essere presente nella lista colori.
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <button type="button" class="btn btn-outline-secondary w-100 mb-2" onclick="loadExampleJson()">
                                <i class="fas fa-file-import me-2"></i>
                                Carica JSON di Esempio
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button type="submit" class="btn btn-primary w-100 mb-2">
                                <i class="fas fa-cogs me-2"></i>
                                <span class="btn-text">Ottimizza da JSON</span>
                                <span class="spinner-border spinner-border-sm d-none" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </span>
                            </button>
                        </div>
                    </div>
                </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stato Cabine -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tachometer-alt me-2"></i>
                    Stato Cabine
                </h5>
            </div>
            <div class="card-body">
                <div class="cabin-status" id="cabinStatus">
                    <div class="row">
                        <div class="col-12 mb-3">
                            <div class="card cabin-card bg-light">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="card-title mb-1">
                                                <i class="fas fa-industry me-2 text-primary"></i>
                                                Cabina 1 (Corto)
                                            </h6>
                                            <p class="card-text small text-muted mb-1">
                                                <span id="cabin1-total">0</span> colori totali
                                            </p>
                                            <p class="card-text small text-muted mb-0">
                                                In esecuzione: <span id="cabin1-executing">0</span> | 
                                                Completati: <span id="cabin1-completed">0</span>
                                            </p>
                                        </div>
                                        <a href="{{ url_for('cabin_view', cabin_id=1) }}" class="btn btn-outline-primary btn-sm">
                                            Visualizza
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-12">
                            <div class="card cabin-card bg-light">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="card-title mb-1">
                                                <i class="fas fa-industry me-2 text-success"></i>
                                                Cabina 2 (Lungo)
                                            </h6>
                                            <p class="card-text small text-muted mb-1">
                                                <span id="cabin2-total">0</span> colori totali
                                            </p>
                                            <p class="card-text small text-muted mb-0">
                                                In esecuzione: <span id="cabin2-executing">0</span> | 
                                                Completati: <span id="cabin2-completed">0</span>
                                            </p>
                                        </div>
                                        <a href="{{ url_for('cabin_view', cabin_id=2) }}" class="btn btn-outline-success btn-sm">
                                            Visualizza
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Azioni Rapide -->
        <div class="card mt-3">
            <div class="card-header bg-secondary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bolt me-2"></i>
                    Azioni Rapide
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="refreshCabinStatus()">
                        <i class="fas fa-sync-alt me-2"></i>
                        Aggiorna Stato Cabine
                    </button>
                    <button type="button" class="btn btn-outline-warning btn-sm" onclick="clearAllData()">
                        <i class="fas fa-trash-alt me-2"></i>
                        Pulisci Tutte le Liste
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Risultati Ottimizzazione -->
<div class="row mt-4" id="resultsContainer" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-check-circle me-2"></i>
                        Risultati Ottimizzazione
                    </h5>
                    <button type="button" class="btn btn-light btn-sm" onclick="exportToExcel()" id="exportButton" style="display: none;">
                        <i class="fas fa-file-excel me-2"></i>
                        Esporta Excel
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="optimizationResults">
                    <!-- I risultati verranno inseriti qui via JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SheetJS per esportazione Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// Backend URL configuration - detect which URL works
const DOCKER_BACKEND_URL = "{{ docker_backend_url }}";
const HOST_BACKEND_URL = "{{ host_backend_url }}";
let BACKEND_URL = null;

console.log('DEBUG: DOCKER_BACKEND_URL:', DOCKER_BACKEND_URL);
console.log('DEBUG: HOST_BACKEND_URL:', HOST_BACKEND_URL);

// Function to test backend connectivity
async function detectBackendUrl() {
    console.log('DEBUG: Testing backend connectivity...');
    
    // First try the Docker internal URL
    try {
        const response = await fetch(DOCKER_BACKEND_URL + '/', { method: 'GET', timeout: 2000 });
        if (response.ok) {
            BACKEND_URL = DOCKER_BACKEND_URL;
            console.log('DEBUG: Using Docker backend URL:', BACKEND_URL);
            return;
        }
    } catch (error) {
        console.log('DEBUG: Docker backend not reachable:', error.message);
    }
    
    // If Docker URL fails, try the host URL
    try {
        const response = await fetch(HOST_BACKEND_URL + '/', { method: 'GET', timeout: 2000 });
        if (response.ok) {
            BACKEND_URL = HOST_BACKEND_URL;
            console.log('DEBUG: Using host backend URL:', BACKEND_URL);
            return;
        }
    } catch (error) {
        console.log('DEBUG: Host backend not reachable:', error.message);
    }
    
    // If both fail, default to host URL and log error
    BACKEND_URL = HOST_BACKEND_URL;
    console.error('DEBUG: No backend reachable, defaulting to:', BACKEND_URL);
}

// Variabili globali per i clusters disponibili e la lista temporanea
let availableClusters = [];
let temporaryList = [];
let lastOptimizationResults = null; // Per esportazione Excel

// Carica i clusters disponibili al caricamento della pagina
$(document).ready(async function() {
    console.log('Document ready - Inizializzo il sistema...');
    console.log('jQuery versione:', $.fn.jquery);
    console.log('Elementi cabin1InputBody trovati:', $('#cabin1InputBody').length);
    console.log('Elementi cabin2InputBody trovati:', $('#cabin2InputBody').length);
    
    // First detect which backend URL works
    await detectBackendUrl();
    console.log('DEBUG: Final BACKEND_URL selected:', BACKEND_URL);
    
    // Debug visibile nella pagina
    $('body').append('<div id="debugInfo" style="position:fixed;top:10px;right:10px;background:yellow;padding:10px;z-index:9999;font-size:12px;"></div>');
    $('#debugInfo').html(`
        jQuery: ${$.fn.jquery}<br>
        cabin1InputBody: ${$('#cabin1InputBody').length}<br>
        cabin2InputBody: ${$('#cabin2InputBody').length}<br>
        cabin1RowCounter: ${cabin1RowCounter}<br>
        cabin2RowCounter: ${cabin2RowCounter}<br>
        BACKEND_URL: ${BACKEND_URL}
    `);
    
    // Carica clusters e aggiorna stato cabine
    loadAvailableClusters();
    refreshCabinStatus();
    
    // Inizializza le tabelle bulk
    initBulkTable();
    
    // Gestisce l'icona di toggle per la sezione JSON
    $('#jsonFormCollapse').on('show.bs.collapse', function () {
        $('#jsonToggleIcon').removeClass('fa-chevron-down').addClass('fa-chevron-up');
    });
    
    $('#jsonFormCollapse').on('hide.bs.collapse', function () {
        $('#jsonToggleIcon').removeClass('fa-chevron-up').addClass('fa-chevron-down');
    });
});

// Carica la lista dei clusters disponibili
function loadAvailableClusters() {
    $.get('/api/clusters')
        .done(function(data) {
            availableClusters = data.clusters || [];
            const startSelect = $('#startCluster');
            const clusterSelect = $('#colorCluster');
            
            // Popola select cluster di partenza
            startSelect.empty();
            startSelect.append('<option value="">-- Seleziona cluster di partenza --</option>');
            availableClusters.forEach(cluster => {
                startSelect.append(`<option value="${cluster}">${cluster}</option>`);
            });
            
            // Popola select cluster per aggiunta manuale
            clusterSelect.empty();
            clusterSelect.append('<option value="">Auto-determina</option>');
            availableClusters.forEach(cluster => {
                clusterSelect.append(`<option value="${cluster}">${cluster}</option>`);
            });
        })
        .fail(function() {
            console.warn('Impossibile caricare i clusters disponibili');
        });
}

// === FUNZIONI PER AGGIUNTA MANUALE ===

// Aggiorna visualizzazione lista temporanea
function updateTemporaryListDisplay() {
    const container = $('#temporaryListContainer');
    const tbody = $('#temporaryListBody');
    const count = $('#temporaryCount');
    
    if (temporaryList.length === 0) {
        container.hide();
        return;
    }
    
    container.show();
    count.text(temporaryList.length);
    tbody.empty();
    
    temporaryList.forEach((color, index) => {
        const row = $(`
            <tr>
                <td><span class="color-code">${color.code}</span></td>
                <td><span class="badge bg-secondary">${color.type}</span></td>
                <td>${color.cluster || 'Auto'}</td>
                <td>${color.CH || 'N/D'}</td>
                <td><span class="badge ${color.lunghezza_ordine === 'lungo' ? 'bg-success' : 'bg-primary'}">${color.lunghezza_ordine}</span></td>
                <td>${color.sequence || 'N/D'}</td>
                <td>${color.sequence_type || 'N/D'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeFromTemporary(${color.temp_id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `);
        tbody.append(row);
    });
}

// Rimuovi dalla lista temporanea
function removeFromTemporary(tempId) {
    temporaryList = temporaryList.filter(c => c.temp_id !== tempId);
    updateTemporaryListDisplay();
}

// Pulisci lista temporanea
function clearTemporaryList() {
    temporaryList = [];
    updateTemporaryListDisplay();
}

// Pulisci lista temporanea
function clearTemporaryList() {
    temporaryList = [];
    updateTemporaryListDisplay();
}

// Carica JSON di esempio
function loadExampleJson() {
    const exampleJson = [
        {"code": "RAL7048", "type": "E", "CH": 1.5, "lunghezza_ordine": "corto"},
        {"code": "RAL7044", "type": "E", "CH": 2.0, "lunghezza_ordine": "corto"},
        {"code": "RAL5017", "type": "K", "CH": 3.2, "lunghezza_ordine": "lungo"},
        {"code": "69115038", "type": "R", "CH": 1.8, "lunghezza_ordine": "corto"},
        {"code": "RAL1019", "type": "RE", "CH": 2.5, "lunghezza_ordine": "lungo"},
        {"code": "160024", "type": "F", "CH": 4.1, "lunghezza_ordine": "lungo"},
        {"code": "20889000", "type": "E", "CH": 1.2, "lunghezza_ordine": "corto"},
        {"code": "54864032", "type": "K", "CH": 3.8, "lunghezza_ordine": "lungo"},
        {"code": "RAL9023", "type": "E", "CH": 2.1, "lunghezza_ordine": "corto"},
        {"code": "RAL9006", "type": "E", "CH": 2.3, "lunghezza_ordine": "lungo"},
        {"code": "RAL9007", "type": "E", "CH": 2.7, "lunghezza_ordine": "lungo"},
        {"code": "RAL9001", "type": "E", "CH": 1.9, "lunghezza_ordine": "corto"},
        {"code": "160058", "type": "K", "CH": 3.5, "lunghezza_ordine": "lungo"},
        {"code": "160000", "type": "K", "CH": 3.6, "lunghezza_ordine": "lungo"},
        {"code": "52546000", "type": "E", "CH": 1.7, "lunghezza_ordine": "corto"},
        {"code": "38399000", "type": "RE", "CH": 2.8, "lunghezza_ordine": "lungo"},
        {"code": "47177000", "type": "K", "CH": 3.1, "lunghezza_ordine": "lungo"},
        {"code": "RAL7024", "type": "K", "CH": 3.0, "lunghezza_ordine": "lungo"},
        {"code": "RAL7015", "type": "F", "CH": 4.0, "lunghezza_ordine": "lungo"},
        {"code": "RAL7011", "type": "K", "CH": 3.3, "lunghezza_ordine": "lungo"},
        {"code": "RAL8019", "type": "K", "CH": 3.4, "lunghezza_ordine": "lungo"},
        {"code": "RAL9006", "type": "K", "CH": 3.7, "lunghezza_ordine": "lungo"},
        {"code": "RAL9007", "type": "K", "CH": 3.9, "lunghezza_ordine": "lungo"},
        {"code": "RAL9023", "type": "K", "CH": 2.2, "lunghezza_ordine": "lungo"},
        {"code": "RAL9005", "type": "F", "CH": 4.2, "lunghezza_ordine": "lungo"},
        {"code": "RAL9007", "type": "F", "CH": 4.3, "lunghezza_ordine": "lungo"},
        {"code": "RAL7035", "type": "F", "CH": 4.4, "lunghezza_ordine": "lungo"},
        {"code": "RAL3020", "type": "F", "CH": 4.5, "lunghezza_ordine": "lungo"},
        {"code": "RAL9003", "type": "K", "CH": 3.0, "lunghezza_ordine": "lungo"},
        {"code": "RAL7045", "type": "K", "CH": 3.1, "lunghezza_ordine": "lungo"},
        {"code": "RAL7032", "type": "E", "CH": 2.6, "lunghezza_ordine": "corto"},
        {"code": "RAL7030", "type": "E", "CH": 2.4, "lunghezza_ordine": "corto"},
        {"code": "RAL1013", "type": "RE", "CH": 2.9, "lunghezza_ordine": "lungo"},
        {"code": "RAL1015", "type": "RE", "CH": 2.7, "lunghezza_ordine": "lungo"},
        {"code": "RAL1017", "type": "RE", "CH": 2.6, "lunghezza_ordine": "lungo"},
        {"code": "RAL2004", "type": "F", "CH": 4.6, "lunghezza_ordine": "lungo"},
        {"code": "RAL3000", "type": "F", "CH": 4.7, "lunghezza_ordine": "lungo"},
        {"code": "RAL4001", "type": "F", "CH": 4.8, "lunghezza_ordine": "lungo"},
        {"code": "RAL5002", "type": "K", "CH": 3.2, "lunghezza_ordine": "lungo"},
        {"code": "RAL6005", "type": "K", "CH": 3.3, "lunghezza_ordine": "lungo"},
        {"code": "RAL7001", "type": "E", "CH": 2.5, "lunghezza_ordine": "corto"},
        {"code": "RAL8003", "type": "E", "CH": 2.8, "lunghezza_ordine": "corto"}
    ];
    $('#colorsJson').val(JSON.stringify(exampleJson, null, 2));
}

// Gestione form ottimizzazione
$('#optimizationForm').on('submit', function(e) {
    e.preventDefault();
    
    const colorsJsonText = $('#colorsJson').val().trim();
    const startCluster = $('#startCluster').val();
    const firstColor = $('#firstColor').val().trim();
    
    if (!colorsJsonText) {
        alert('Inserisci la lista colori in formato JSON');
        return;
    }
    
    let colorsData;
    try {
        colorsData = JSON.parse(colorsJsonText);
    } catch (error) {
        alert('Formato JSON non valido: ' + error.message);
        return;
    }
    
    if (!Array.isArray(colorsData) || colorsData.length === 0) {
        alert('La lista colori deve essere un array non vuoto');
        return;
    }
    
    // Verifica che il primo colore sia presente nella lista se specificato
    if (firstColor && !colorsData.some(c => c.code === firstColor)) {
        alert(`Il primo colore "${firstColor}" deve essere presente nella lista colori.`);
        return;
    }
    
    // Mostra spinner
    const btnText = $('.btn-text');
    const spinner = $('.spinner-border');
    btnText.addClass('d-none');
    spinner.removeClass('d-none');
    $('button[type="submit"]').prop('disabled', true);
    
    // Prepara i dati per l'API
    const requestData = {
        colors_today: colorsData,
        start_cluster_name: startCluster || null,
        first_color: firstColor || null
    };
    
    // Debug: Log dei dati inviati
    console.log('DEBUG: Dati inviati al backend:', requestData);
    console.log('DEBUG: startCluster:', startCluster, typeof startCluster);
    console.log('DEBUG: firstColor:', firstColor, typeof firstColor);
    console.log('DEBUG: firstColor dopo trim:', firstColor ? firstColor.trim() : 'empty');
    console.log('DEBUG: firstColor nel requestData:', requestData.first_color);
    
    // Verifica se il primo colore è nella lista
    if (firstColor) {
        const foundColor = colorsData.find(c => c.code === firstColor);
        if (foundColor) {
            console.log('DEBUG: firstColor trovato nella lista:', foundColor);
        } else {
            console.log('DEBUG: firstColor NON trovato nella lista colori!');
            console.log('DEBUG: colori disponibili:', colorsData.map(c => c.code));
        }
    }
    
    // Chiama l'API di ottimizzazione
    const optimizeUrl = BACKEND_URL + '/optimize';
    console.log('DEBUG: About to call AJAX with URL:', optimizeUrl);
    $.ajax({
        url: optimizeUrl,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(requestData),
        timeout: 60000, // 60 secondi timeout
        success: function(response) {
            displayOptimizationResults(response);
            refreshCabinStatus();
            $('#resultsContainer').show();
        },
        error: function(xhr, status, error) {
            let errorMessage = 'Errore durante l\'ottimizzazione';
            if (xhr.responseJSON && xhr.responseJSON.detail) {
                errorMessage = xhr.responseJSON.detail;
            } else if (status === 'timeout') {
                errorMessage = 'Timeout: l\'ottimizzazione sta richiedendo troppo tempo';
            }
            alert(errorMessage);
        },
        complete: function() {
            // Nascondi spinner
            btnText.removeClass('d-none');
            spinner.addClass('d-none');
            $('button[type="submit"]').prop('disabled', false);
        }
    });
});

// Visualizza risultati ottimizzazione
function displayOptimizationResults(results) {
    // Salva i risultati per l'esportazione Excel
    lastOptimizationResults = results;
    
    const container = $('#optimizationResults');
    container.empty();
    
    if (results.cabina_1 && results.cabina_2) {
        // Risultati per cabine separate
        container.append(`
            <div class="alert alert-info">
                <h6><i class="fas fa-info-circle me-2"></i>Ottimizzazione completata per entrambe le cabine</h6>
                <p class="mb-0">${results.message}</p>
            </div>
        `);
        
        if (results.cabina_1.ordered_colors && results.cabina_1.ordered_colors.length > 0) {
            container.append(`
                <div class="alert alert-success">
                    <h6><i class="fas fa-industry me-2"></i>Cabina 1 (Corto)</h6>
                    <p class="mb-1"><strong>Colori ottimizzati:</strong> ${results.cabina_1.ordered_colors.length}</p>
                    <p class="mb-1"><strong>Sequenza cluster:</strong> ${results.cabina_1.optimal_cluster_sequence.join(' → ')}</p>
                    <p class="mb-0"><strong>Costo calcolato:</strong> ${results.cabina_1.calculated_cost}</p>
                </div>
            `);
        }
        
        if (results.cabina_2.ordered_colors && results.cabina_2.ordered_colors.length > 0) {
            container.append(`
                <div class="alert alert-success">
                    <h6><i class="fas fa-industry me-2"></i>Cabina 2 (Lungo)</h6>
                    <p class="mb-1"><strong>Colori ottimizzati:</strong> ${results.cabina_2.ordered_colors.length}</p>
                    <p class="mb-1"><strong>Sequenza cluster:</strong> ${results.cabina_2.optimal_cluster_sequence.join(' → ')}</p>
                    <p class="mb-0"><strong>Costo calcolato:</strong> ${results.cabina_2.calculated_cost}</p>
                </div>
            `);
        }
    } else {
        // Risultati standard
        container.append(`
            <div class="alert alert-success">
                <h6><i class="fas fa-check-circle me-2"></i>Ottimizzazione completata</h6>
                <p class="mb-1"><strong>Colori ottimizzati:</strong> ${results.ordered_colors.length}</p>
                <p class="mb-1"><strong>Sequenza cluster:</strong> ${results.optimal_cluster_sequence.join(' → ')}</p>
                <p class="mb-1"><strong>Costo calcolato:</strong> ${results.calculated_cost}</p>
                <p class="mb-0">${results.message}</p>
            </div>
        `);
    }
    
    container.append(`
        <div class="text-center mt-3">
            <a href="${window.location.origin}/cabin/1" class="btn btn-primary me-2">
                <i class="fas fa-eye me-2"></i>Visualizza Cabina 1
            </a>
            <a href="${window.location.origin}/cabin/2" class="btn btn-success">
                <i class="fas fa-eye me-2"></i>Visualizza Cabina 2
            </a>
        </div>
    `);
    
    // Mostra il pulsante di esportazione Excel
    $('#exportButton').show();
}

// Visualizza i risultati combinati delle due cabine
function displayCombinedOptimizationResults(results) {
    // Debug: logga la struttura completa dei risultati
    console.log('DEBUG: displayCombinedOptimizationResults chiamata con:', results);
    console.log('DEBUG: results.cabina_1:', results.cabina_1);
    console.log('DEBUG: results.cabina_2:', results.cabina_2);
    
    // Salva i risultati per l'esportazione Excel
    lastOptimizationResults = results;
    
    const container = $('#optimizationResults');
    container.empty();

    container.append(`
        <div class="alert alert-info">
            <h6><i class="fas fa-info-circle me-2"></i>Ottimizzazione completata per entrambe le cabine separatamente</h6>
            <p class="mb-0">Le cabine sono state ottimizzate indipendentemente per garantire la massima efficienza.</p>
        </div>
    `);    // Mostra risultati Cabina 1
    console.log('DEBUG: Checking cabina_1 conditions...');
    console.log('DEBUG: results.cabina_1 exists:', !!results.cabina_1);
    console.log('DEBUG: results.cabina_1.ordered_colors exists:', !!(results.cabina_1 && results.cabina_1.ordered_colors));
    console.log('DEBUG: results.cabina_1.ordered_colors.length:', results.cabina_1 && results.cabina_1.ordered_colors ? results.cabina_1.ordered_colors.length : 'N/A');
    
    if (results.cabina_1 && results.cabina_1.ordered_colors && results.cabina_1.ordered_colors.length > 0) {
        console.log('DEBUG: Mostrando risultati Cabina 1 con', results.cabina_1.ordered_colors.length, 'colori');
        container.append(`
            <div class="alert alert-primary">
                <h6><i class="fas fa-industry me-2 text-primary"></i>Cabina 1 (Corto)</h6>
                <p class="mb-1"><strong>Colori ottimizzati:</strong> ${results.cabina_1.ordered_colors.length}</p>
                <p class="mb-1"><strong>Sequenza cluster:</strong> ${results.cabina_1.optimal_cluster_sequence ? results.cabina_1.optimal_cluster_sequence.join(' → ') : 'N/D'}</p>
                <p class="mb-0"><strong>Costo calcolato:</strong> ${results.cabina_1.calculated_cost || 'N/D'}</p>
            </div>
        `);
        
        // Tabella dettagliata per Cabina 1
        let cabin1Table = `
            <div class="table-responsive mt-3">
                <table class="table table-striped table-sm">
                    <thead class="table-primary">
                        <tr>
                            <th>Posizione</th>
                            <th>Codice Colore</th>
                            <th>Tipo</th>
                            <th>Cluster</th>
                            <th>CH</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        results.cabina_1.ordered_colors.forEach((color, index) => {
            cabin1Table += `
                <tr>
                    <td><strong>${index + 1}</strong></td>
                    <td><code class="color-code">${color.code}</code></td>
                    <td><span class="badge bg-primary">${color.type}</span></td>
                    <td><span class="badge bg-secondary">${color.cluster || 'N/D'}</span></td>
                    <td>${color.CH || 'N/D'}</td>
                </tr>
            `;
        });
        
        cabin1Table += `
                    </tbody>
                </table>
            </div>
        `;
        
        console.log('DEBUG: Aggiungendo tabella Cabina 1:', cabin1Table.substring(0, 200) + '...');
        container.append(cabin1Table);
    } else if (results.cabina_1 === null) {
        console.log('DEBUG: Cabina 1 è null, mostrando messaggio vuoto');
        container.append(`
            <div class="alert alert-secondary">
                <h6><i class="fas fa-industry me-2"></i>Cabina 1 (Corto)</h6>
                <p class="mb-0">Nessun colore inserito per questa cabina.</p>
            </div>
        `);
    } else {
        console.log('DEBUG: Cabina 1 non soddisfa le condizioni, saltando...');
    }

    // Mostra risultati Cabina 2
    if (results.cabina_2 && results.cabina_2.ordered_colors && results.cabina_2.ordered_colors.length > 0) {
        container.append(`
            <div class="alert alert-success">
                <h6><i class="fas fa-industry me-2 text-success"></i>Cabina 2 (Lungo)</h6>
                <p class="mb-1"><strong>Colori ottimizzati:</strong> ${results.cabina_2.ordered_colors.length}</p>
                <p class="mb-1"><strong>Sequenza cluster:</strong> ${results.cabina_2.optimal_cluster_sequence ? results.cabina_2.optimal_cluster_sequence.join(' → ') : 'N/D'}</p>
                <p class="mb-0"><strong>Costo calcolato:</strong> ${results.cabina_2.calculated_cost || 'N/D'}</p>
            </div>
        `);
        
        // Tabella dettagliata per Cabina 2
        let cabin2Table = `
            <div class="table-responsive mt-3">
                <table class="table table-striped table-sm">
                    <thead class="table-success">
                        <tr>
                            <th>Posizione</th>
                            <th>Codice Colore</th>
                            <th>Tipo</th>
                            <th>Cluster</th>
                            <th>CH</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        results.cabina_2.ordered_colors.forEach((color, index) => {
            cabin2Table += `
                <tr>
                    <td><strong>${index + 1}</strong></td>
                    <td><code class="color-code">${color.code}</code></td>
                    <td><span class="badge bg-success">${color.type}</span></td>
                    <td><span class="badge bg-secondary">${color.cluster || 'N/D'}</span></td>
                    <td>${color.CH || 'N/D'}</td>
                </tr>
            `;
        });
        
        cabin2Table += `
                    </tbody>
                </table>
            </div>
        `;
        
        container.append(cabin2Table);
    } else if (results.cabina_2 === null) {
        container.append(`
            <div class="alert alert-secondary">
                <h6><i class="fas fa-industry me-2"></i>Cabina 2 (Lungo)</h6>
                <p class="mb-0">Nessun colore inserito per questa cabina.</p>
            </div>
        `);
    }    container.append(`
        <div class="text-center mt-3">
            <a href="${window.location.origin}/cabin/1" class="btn btn-primary me-2">
                <i class="fas fa-eye me-2"></i>Visualizza Cabina 1
            </a>
            <a href="${window.location.origin}/cabin/2" class="btn btn-success">
                <i class="fas fa-eye me-2"></i>Visualizza Cabina 2
            </a>
        </div>
    `);
    
    // Mostra il pulsante di esportazione Excel
    $('#exportButton').show();
}

// Aggiorna stato cabine
function refreshCabinStatus() {
    $.get('/api/cabin-status')
        .done(function(data) {
            if (data.cabin_1) {
                $('#cabin1-total').text(data.cabin_1.total || 0);
                $('#cabin1-executing').text(data.cabin_1.executing || 0);
                $('#cabin1-completed').text(data.cabin_1.completed || 0);
            }
            
            if (data.cabin_2) {
                $('#cabin2-total').text(data.cabin_2.total || 0);
                $('#cabin2-executing').text(data.cabin_2.executing || 0);
                $('#cabin2-completed').text(data.cabin_2.completed || 0);
            }
        })
        .fail(function() {
            console.warn('Impossibile aggiornare lo stato delle cabine');
        });
}

// Pulisci tutti i dati
function clearAllData() {
    if (confirm('Sei sicuro di voler pulire tutte le liste delle cabine? Questa operazione non può essere annullata.')) {
        $.post('/api/clear-all')
            .done(function() {
                alert('Tutte le liste sono state pulite con successo');
                refreshCabinStatus();
                $('#resultsContainer').hide();
            })
            .fail(function() {
                alert('Errore durante la pulizia dei dati');
            });
    }
}

// === FUNZIONI PER INPUT VELOCE COLORI ===

let cabin1RowCounter = 0;
let cabin2RowCounter = 0;

// Inizializza le tabelle bulk per entrambe le cabine
function initBulkTable() {
    console.log('initBulkTable: Inizializzo le tabelle per entrambe le cabine...');
    
    // Pulisci le tabelle se ci sono già delle righe
    $('#cabin1InputBody').empty();
    $('#cabin2InputBody').empty();
    cabin1RowCounter = 0;
    cabin2RowCounter = 0;
    
    console.log('initBulkTable: Tabelle pulite, aggiungendo righe iniziali...');
    
    // Aggiungi la prima riga per entrambe le cabine
    const cabin1Id = addBulkRow('cabin1');
    const cabin2Id = addBulkRow('cabin2');
    
    console.log(`initBulkTable: Completato! Cabina 1 riga ${cabin1Id}, Cabina 2 riga ${cabin2Id}`);
    console.log('Tabelle bulk inizializzate per entrambe le cabine con funzionalità paste multiplo');
}

// Aggiungi una nuova riga alla tabella bulk (modificata per supportare entrambe le cabine)
function addBulkRow(cabinId = 'cabin1', colorCode = '') {
    console.log(`addBulkRow: Chiamata con cabinId='${cabinId}', colorCode='${colorCode}'`);
    
    const iscabin1 = cabinId === 'cabin1';
    const counter = iscabin1 ? ++cabin1RowCounter : ++cabin2RowCounter;
    const tbody = iscabin1 ? $('#cabin1InputBody') : $('#cabin2InputBody');
    const prefix = iscabin1 ? 'cabin1' : 'cabin2';
    
    console.log(`addBulkRow: tbody elemento trovato:`, tbody.length > 0);
    console.log(`addBulkRow: counter = ${counter}, prefix = ${prefix}`);
    
    const row = $(`
        <tr id="${prefix}Row${counter}">
            <td>
                <input type="text" class="form-control bulk-color-input" id="${prefix}Color${counter}" placeholder="es. RAL9005" value="${colorCode}">
            </td>
            <td>
                <select class="form-select" id="${prefix}Type${counter}">
                    <option value="">Seleziona</option>
                    <option value="R">R - Reintegro Urgente</option>
                    <option value="RE">RE - Reintegro</option>
                    <option value="F">F - Fisso</option>
                    <option value="K">K - Kit</option>
                    <option value="E">E - Estetico</option>
                </select>
            </td>
            <td>
                <input type="number" class="form-control" id="${prefix}Sequence${counter}" placeholder="1">
            </td>
            <td>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBulkRow('${cabinId}', ${counter})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `);
    
    console.log(`addBulkRow: Aggiungendo riga...`);
    tbody.prepend(row);
    
    console.log(`addBulkRow: Riga aggiunta! Righe totali nella tabella:`, tbody.find('tr').length);
    
    // Aggiungi event listener per il paste
    const input = $(`#${prefix}Color${counter}`);
    setupPasteHandler(input, cabinId);
    
    return counter;
}

// Aggiungi una nuova riga dopo una riga specifica (per paste multiplo)
function addBulkRowAfter(cabinId, afterRowId, colorCode = '') {
    const iscabin1 = cabinId === 'cabin1';
    const counter = iscabin1 ? ++cabin1RowCounter : ++cabin2RowCounter;
    const prefix = iscabin1 ? 'cabin1' : 'cabin2';
    const afterRow = $(`#${prefix}Row${afterRowId}`);
    
    const row = $(`
        <tr id="${prefix}Row${counter}">
            <td>
                <input type="text" class="form-control bulk-color-input" id="${prefix}Color${counter}" placeholder="es. RAL9005" value="${colorCode}">
            </td>
            <td>
                <select class="form-select" id="${prefix}Type${counter}">
                    <option value="">Seleziona</option>
                    <option value="R">R - Reintegro Urgente</option>
                    <option value="RE">RE - Reintegro</option>
                    <option value="F">F - Fisso</option>
                    <option value="K">K - Kit</option>
                    <option value="E">E - Estetico</option>
                </select>
            </td>
            <td>
                <input type="number" class="form-control" id="${prefix}Sequence${counter}" placeholder="1">
            </td>
            <td>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBulkRow('${cabinId}', ${counter})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `);
    afterRow.after(row);
    
    // Aggiungi event listener per il paste
    const input = $(`#${prefix}Color${counter}`);
    setupPasteHandler(input, cabinId);
    
    return counter;
}

// Rimuovi una riga dalla tabella bulk
function removeBulkRow(cabinId, rowId) {
    const iscabin1 = cabinId === 'cabin1';
    const tbody = iscabin1 ? $('#cabin1InputBody') : $('#cabin2InputBody');
    const prefix = iscabin1 ? 'cabin1' : 'cabin2';
    
    $(`#${prefix}Row${rowId}`).remove();
    
    // Se non ci sono più righe, aggiungine una vuota
    if (tbody.children().length === 0) {
        addBulkRow(cabinId);
    }
}

// Pulisci la tabella bulk
function clearBulkTable(cabinId = 'cabin1') {
    const iscabin1 = cabinId === 'cabin1';
    const tbody = iscabin1 ? $('#cabin1InputBody') : $('#cabin2InputBody');
    
    tbody.empty();
    
    if (iscabin1) {
        cabin1RowCounter = 0;
    } else {
        cabin2RowCounter = 0;
    }
    
    addBulkRow(cabinId);
}

// Configura il gestore di paste per input veloce
function setupPasteHandler(input, cabinId) {
    input.on('paste', function(e) {
        // Previeni il comportamento di default del paste
        e.preventDefault();
        
        // Ottieni il contenuto dalla clipboard
        const clipboardData = e.originalEvent.clipboardData || window.clipboardData;
        const pastedText = clipboardData.getData('text/plain').trim();
        
        console.log('Paste rilevato per', cabinId, ':', pastedText);
        
        // Controlla se il testo contiene più righe
        const lines = pastedText.split(/[\n\r]+/).map(line => line.trim()).filter(line => line);
        
        if (lines.length > 1) {
            // Paste multiplo: gestisci le righe separate
            handleMultiLinePaste($(this), lines, cabinId);
        } else {
            // Paste singolo: inserisci normalmente
            $(this).val(pastedText);
        }
    });
}

// Gestisce il paste di più righe di codici colore
function handleMultiLinePaste(input, lines, cabinId) {
    console.log('Gestendo paste multiplo per', cabinId, ':', lines);
    
    // Determina se i dati sono in formato CSV (Codice,Tipologia,Sequenza)
    const isCSVFormat = lines.some(line => line.includes(',') && line.split(',').length >= 2);
    
    if (isCSVFormat) {
        handleCSVPaste(input, lines, cabinId);
    } else {
        handleSimplePaste(input, lines, cabinId);
    }
}

// Gestisce il paste di dati in formato CSV (Codice,Tipologia,Sequenza)
function handleCSVPaste(input, lines, cabinId) {
    console.log('Gestendo paste CSV per', cabinId, ':', lines);
    
    const iscabin1 = cabinId === 'cabin1';
    const tbody = iscabin1 ? $('#cabin1InputBody') : $('#cabin2InputBody');
    const prefix = iscabin1 ? 'cabin1' : 'cabin2';
    const currentRowId = input.attr('id').replace(`${prefix}Color`, '');
    let validRows = 0;
    let processedData = [];
    
    // Analizza ogni riga CSV
    lines.forEach((line, index) => {
        const trimmedLine = line.trim();
        if (!trimmedLine) return;
        
        const parts = trimmedLine.split(',').map(part => part.trim());
        if (parts.length >= 2) {
            const colorCode = parts[0];
            const colorType = parts[1];
            const colorSequence = parts.length >= 3 ? parts[2] : '';
            
            if (colorCode && colorType) {
                processedData.push({
                    code: colorCode,
                    type: colorType,
                    sequence: colorSequence,
                    index: index
                });
                validRows++;
            }
        }
    });
    
    if (processedData.length === 0) {
        showBulkMessage(`⚠️ Formato CSV non valido per ${cabinId}. Usa: Codice,Tipologia,Sequenza`, 'warning');
        return;
    }
    
    // Rimuovi righe vuote successive
    tbody.find('tr').each(function() {
        const rowId = $(this).attr('id').replace(`${prefix}Row`, '');
        if (parseInt(rowId) > parseInt(currentRowId)) {
            const colorInput = $(this).find('.bulk-color-input');
            if (!colorInput.val().trim()) {
                $(this).remove();
            }
        }
    });
    
    // Popola la prima riga corrente
    if (processedData.length > 0) {
        const firstData = processedData[0];
        input.val(firstData.code);
        $(`#${prefix}Type${currentRowId}`).val(firstData.type);
        if (firstData.sequence) {
            $(`#${prefix}Sequence${currentRowId}`).val(firstData.sequence);
        }
        
        // Aggiungi evidenziazione
        input.addClass('highlight-paste');
        $(`#${prefix}Type${currentRowId}`).addClass('highlight-paste');
        if (firstData.sequence) {
            $(`#${prefix}Sequence${currentRowId}`).addClass('highlight-paste');
        }
    }
    
    // Crea nuove righe per i dati rimanenti
    let lastRowId = parseInt(currentRowId);
    for (let i = 1; i < processedData.length; i++) {
        const data = processedData[i];
        const newRowId = addBulkRowAfter(cabinId, lastRowId, data.code);
        lastRowId = newRowId;
        
        // Popola tipologia e sequenza
        setTimeout(() => {
            $(`#${prefix}Type${newRowId}`).val(data.type);
            if (data.sequence) {
                $(`#${prefix}Sequence${newRowId}`).val(data.sequence);
            }
            
            // Aggiungi evidenziazione
            $(`#${prefix}Color${newRowId}`).addClass('highlight-paste');
            $(`#${prefix}Type${newRowId}`).addClass('highlight-paste');
            if (data.sequence) {
                $(`#${prefix}Sequence${newRowId}`).addClass('highlight-paste');
            }
        }, 50);
    }
    
    showBulkMessage(`✅ Importati ${validRows} colori in ${cabinId} con tipologia e sequenza dal formato CSV!`, 'success');
    
    // Rimuovi evidenziazione dopo 3 secondi
    setTimeout(() => {
        $('.highlight-paste').removeClass('highlight-paste');
    }, 3000);
}

// Gestisce il paste semplice (solo codici colore)
function handleSimplePaste(input, lines, cabinId) {
    console.log('Gestendo paste semplice per', cabinId, ':', lines);
    
    const iscabin1 = cabinId === 'cabin1';
    const tbody = iscabin1 ? $('#cabin1InputBody') : $('#cabin2InputBody');
    const prefix = iscabin1 ? 'cabin1' : 'cabin2';
    const currentRowId = input.attr('id').replace(`${prefix}Color`, '');
    
    // Inserisci il primo codice nell'input corrente
    const firstCode = lines[0];
    input.val(firstCode);
    
    // Rimuovi tutte le righe vuote successive a quella corrente
    tbody.find('tr').each(function() {
        const rowId = $(this).attr('id').replace(`${prefix}Row`, '');
        if (parseInt(rowId) > parseInt(currentRowId)) {
            const colorInput = $(this).find('.bulk-color-input');
            if (!colorInput.val().trim()) {
                $(this).remove();
            }
        }
    });
    
    // Aggiungi nuove righe per ogni codice rimanente
    let lastRowId = parseInt(currentRowId);
    for (let i = 1; i < lines.length; i++) {
        const colorCode = lines[i];
        if (colorCode) {
            const newRowId = addBulkRowAfter(cabinId, lastRowId, colorCode);
            lastRowId = newRowId;
        }
    }
    
    // Mostra un messaggio di conferma
    showBulkMessage(`✅ Aggiunti ${lines.length} codici colore in ${cabinId} automaticamente!`, 'success');
    
    // Aggiungi validazione visiva ai nuovi input
    setTimeout(() => {
        lines.forEach((code, index) => {
            const rowNumber = parseInt(currentRowId) + index;
            const input = $(`#${prefix}Color${rowNumber}`);
            if (input.length && isValidColorCode(code)) {
                input.addClass('is-valid');
            }
        });
    }, 100);
}

// Mostra messaggi temporanei per l'input bulk
function showBulkMessage(message, type = 'info') {
    // Rimuovi messaggi precedenti
    $('.bulk-message').remove();
    
    // Crea il nuovo messaggio
    const alertClass = type === 'success' ? 'alert-success' : 
                     type === 'warning' ? 'alert-warning' : 
                     type === 'error' ? 'alert-danger' : 'alert-info';
    
    const messageDiv = $(`
        <div class="alert ${alertClass} alert-dismissible fade show bulk-message" role="alert">
            <small>${message}</small>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `);
    
    // Inserisci il messaggio prima della tabella
    $('.bulk-input-table').parent().before(messageDiv);
    
    // Rimuovi automaticamente dopo 5 secondi
    setTimeout(() => {
        messageDiv.fadeOut(() => messageDiv.remove());
    }, 5000);
}

// Funzione helper per validare codici colore
function isValidColorCode(code) {
    // Regex semplice per validare codici colore RAL o numerici
    const patterns = [
        /^RAL\d{4}$/i,           // RAL + 4 cifre
        /^\d{6,8}$/,             // 6-8 cifre numeriche
        /^[A-Z0-9]{6,10}$/i      // Codici alfanumerici generici
    ];
    
    return patterns.some(pattern => pattern.test(code.trim()));
}

// Migliora la funzione addBulkRow per includere validazione visiva
function addBulkRowWithValidation(colorCode = '') {
    const rowId = addBulkRow(colorCode);
    
    // Se è stato fornito un codice, aggiungi validazione visiva
    if (colorCode) {
        const input = $(`#bulkColor${rowId}`);
        if (isValidColorCode(colorCode)) {
            input.addClass('is-valid');
        } else {
            input.addClass('is-warning');
            input.after('<small class="text-warning">Formato codice non standard</small>');
        }
    }
    
    return rowId;
}

// Gestione cambio lunghezza per input veloce (funzione legacy mantenuta per compatibilità)
function handleLengthChange() {
    console.log('handleLengthChange: funzione legacy non più utilizzata con i moduli separati');
}

// Auto-compila i tipi basandosi sui codici colore
function fillDefaultTypes() {
    const tbody = $('#bulkInputBody');
    let filledCount = 0;
    
    tbody.find('tr').each(function() {
        const rowId = $(this).attr('id');
        if (!rowId) return;
        
        const rowNumber = rowId.replace('bulkRow', '');
        const colorInput = $(`#bulkColor${rowNumber}`);
        const typeSelect = $(`#bulkType${rowNumber}`);
        
        const colorCode = colorInput.val().trim().toUpperCase();
        
        // Solo se il codice è presente e il tipo non è già selezionato
        if (colorCode && !typeSelect.val()) {
            let suggestedType = 'E'; // Default: Estetico
            
            // Logica per determinare il tipo basandosi sul codice
            if (colorCode.startsWith('RAL')) {
                // Codici RAL: principalmente estetici, ma alcuni potrebbero essere fissi
                const ralNumber = parseInt(colorCode.replace('RAL', ''));
                if (ralNumber <= 1000) {
                    suggestedType = 'F'; // Colori base spesso fissi
                } else if (ralNumber >= 9000) {
                    suggestedType = 'E'; // Grigi/bianchi/neri spesso estetici
                } else {
                    suggestedType = 'E'; // Altri RAL generalmente estetici
                }
            } else if (/^\d{8}$/.test(colorCode)) {
                // Codici a 8 cifre: spesso kit o reintegri
                suggestedType = 'K';
            } else if (/^\d{6}$/.test(colorCode)) {
                // Codici a 6 cifre: spesso fissi o kit
                suggestedType = 'F';
            } else if (colorCode.length >= 6) {
                // Altri codici lunghi: spesso kit
                suggestedType = 'K';
            }
            
            typeSelect.val(suggestedType);
            typeSelect.addClass('auto-filled');
            filledCount++;
        }
    });
    
    if (filledCount > 0) {
        showBulkMessage(`🤖 Auto-compilati ${filledCount} tipi di colore! Verifica e modifica se necessario.`, 'info');
        
        // Aggiungi highlight temporaneo ai campi auto-compilati
        $('.auto-filled').addClass('highlight-paste');
        setTimeout(() => {
            $('.auto-filled').removeClass('highlight-paste auto-filled');
        }, 3000);
    } else {
        showBulkMessage('⚠️ Nessun tipo auto-compilato. Assicurati di aver inserito dei codici colore.', 'warning');
    }
}

// Auto-compila i tipi basandosi sui codici colore
function fillDefaultTypes(cabinId = 'cabin1') {
    const iscabin1 = cabinId === 'cabin1';
    const tbody = iscabin1 ? $('#cabin1InputBody') : $('#cabin2InputBody');
    const prefix = iscabin1 ? 'cabin1' : 'cabin2';
    let filledCount = 0;
    
    tbody.find('tr').each(function() {
        const rowId = $(this).attr('id');
        if (!rowId) return;
        
        const rowNumber = rowId.replace(`${prefix}Row`, '');
        const colorInput = $(`#${prefix}Color${rowNumber}`);
        const typeSelect = $(`#${prefix}Type${rowNumber}`);
        
        const colorCode = colorInput.val().trim().toUpperCase();
        
        // Solo se il codice è presente e il tipo non è già selezionato
        if (colorCode && !typeSelect.val()) {
            let suggestedType = 'E'; // Default: Estetico
            
            // Logica per determinare il tipo basandosi sul codice
            if (colorCode.startsWith('RAL')) {
                suggestedType = 'E';
            } else if (/^\d{8}$/.test(colorCode)) {
                suggestedType = 'K';
            }
            
            typeSelect.val(suggestedType);
            typeSelect.addClass('auto-filled');
            filledCount++;
        }
    });
    
    if (filledCount > 0) {
        showBulkMessage(`🤖 Auto-compilati ${filledCount} tipi di colore per ${cabinId}! Verifica e modifica se necessario.`, 'info');
        
        // Aggiungi highlight temporaneo ai campi auto-compilati
        $('.auto-filled').addClass('highlight-paste');
        setTimeout(() => {
            $('.auto-filled').removeClass('highlight-paste auto-filled');
        }, 3000);
    } else {
        showBulkMessage(`⚠️ Nessun tipo auto-compilato per ${cabinId}. Assicurati di aver inserito dei codici colore.`, 'warning');
    }
}

// Processa entrambe le cabine e lancia l'ottimizzazione
function processBothCabins() {
    const cabin1Colors = getCabinColors('cabin1');
    const cabin2Colors = getCabinColors('cabin2');
    
    if (cabin1Colors.length === 0 && cabin2Colors.length === 0) {
        alert('Nessun colore valido da processare in entrambe le cabine. Compila almeno Codice Colore e Tipologia.');
        return;
    }
    
    // Ottieni le configurazioni per entrambe le cabine
    const cabin1StartCluster = $('#cabin1StartCluster').val();
    const cabin1FirstColor = $('#cabin1FirstColor').val().trim();
    const cabin2StartCluster = $('#cabin2StartCluster').val();
    const cabin2FirstColor = $('#cabin2FirstColor').val().trim();
    
    // Verifica che i primi colori siano presenti nelle rispettive liste se specificati
    if (cabin1FirstColor && cabin1Colors.length > 0 && !cabin1Colors.some(c => c.code === cabin1FirstColor)) {
        alert(`Il primo colore "${cabin1FirstColor}" deve essere presente nella lista colori della Cabina 1.`);
        return;
    }
    
    if (cabin2FirstColor && cabin2Colors.length > 0 && !cabin2Colors.some(c => c.code === cabin2FirstColor)) {
        alert(`Il primo colore "${cabin2FirstColor}" deve essere presente nella lista colori della Cabina 2.`);
        return;
    }
    
    // Mostra loading
    const btnText = $('.btn-text-bulk');
    const spinner = $('.spinner-border');
    const button = $('button:contains("Ottimizza Entrambe le Cabine")');
    
    btnText.addClass('d-none');
    spinner.removeClass('d-none');
    button.prop('disabled', true);
    
    console.log('DEBUG: Processando entrambe le cabine:', {
        cabin1Colors: cabin1Colors.length,
        cabin2Colors: cabin2Colors.length
    });
    
    // Processa le cabine in sequenza
    let completedRequests = 0;
    let allResults = {};
    
    function checkCompletion() {
        completedRequests++;
        if (completedRequests === 2) {
            // Entrambe le richieste completate
            console.log('DEBUG: Ottimizzazione completata per entrambe le cabine');
            displayCombinedOptimizationResults(allResults);
            refreshCabinStatus();
            $('#resultsContainer').show();
            clearBulkTable('cabin1'); 
            clearBulkTable('cabin2');
            alert('Ottimizzazione completata con successo per entrambe le cabine!');
            
            // Nascondi spinner
            btnText.removeClass('d-none');
            spinner.addClass('d-none');
            button.prop('disabled', false);
        }
    }
    
    function handleError(cabinName, xhr, status, error) {
        let errorMessage = `Errore durante l'ottimizzazione della ${cabinName}`;
        if (xhr.responseJSON && xhr.responseJSON.detail) {
            errorMessage += ': ' + xhr.responseJSON.detail;
        } else if (status === 'timeout') {
            errorMessage += ': Timeout';
        }
        console.error(`Errore ${cabinName}:`, errorMessage);
        alert(errorMessage);
        
        // Nascondi spinner anche in caso di errore
        btnText.removeClass('d-none');
        spinner.addClass('d-none');
        button.prop('disabled', false);
    }
    
    // Ottimizza Cabina 1 se ha colori
    if (cabin1Colors.length > 0) {
        const requestData1 = {
            colors_today: cabin1Colors,
            start_cluster_name: cabin1StartCluster || null,
            first_color: cabin1FirstColor || null
        };
        
        console.log('DEBUG: Inviando richiesta per Cabina 1:', requestData1);
        
        const optimizeUrl1 = BACKEND_URL + '/optimize';
        console.log('DEBUG: Cabin1 AJAX URL:', optimizeUrl1);
        $.ajax({
            url: optimizeUrl1,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(requestData1),
            timeout: 60000,
            success: function(response) {
                allResults.cabina_1 = response;
                console.log('DEBUG: Risposta Cabina 1:', response);
                checkCompletion();
            },
            error: function(xhr, status, error) {
                handleError('Cabina 1', xhr, status, error);
            }
        });
    } else {
        // Nessun colore per Cabina 1, salta
        allResults.cabina_1 = null;
        checkCompletion();
    }
    
    // Ottimizza Cabina 2 se ha colori
    if (cabin2Colors.length > 0) {
        const requestData2 = {
            colors_today: cabin2Colors,
            start_cluster_name: cabin2StartCluster || null,
            first_color: cabin2FirstColor || null
        };
        
        console.log('DEBUG: Inviando richiesta per Cabina 2:', requestData2);
        
        const optimizeUrl2 = BACKEND_URL + '/optimize';
        console.log('DEBUG: Cabin2 AJAX URL:', optimizeUrl2);
        $.ajax({
            url: optimizeUrl2,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(requestData2),
            timeout: 60000,
            success: function(response) {
                allResults.cabina_2 = response;
                console.log('DEBUG: Risposta Cabina 2:', response);
                checkCompletion();
            },
            error: function(xhr, status, error) {
                handleError('Cabina 2', xhr, status, error);
            }
        });
    } else {
        // Nessun colore per Cabina 2, salta
        allResults.cabina_2 = null;
        checkCompletion();
    }
}

// Funzione helper per ottenere i colori di una cabina
function getCabinColors(cabinId) {
    const iscabin1 = cabinId === 'cabin1';
    const tbody = iscabin1 ? $('#cabin1InputBody') : $('#cabin2InputBody');
    const prefix = iscabin1 ? 'cabin1' : 'cabin2';
    const lunghezza = iscabin1 ? 'corto' : 'lungo';
    const colors = [];
    
    tbody.find('tr').each(function() {
        const rowId = $(this).attr('id');
        if (!rowId) return;
        
        const rowNumber = rowId.replace(`${prefix}Row`, '');
        const colorCode = $(`#${prefix}Color${rowNumber}`).val().trim();
        const colorType = $(`#${prefix}Type${rowNumber}`).val();
        const colorSequence = $(`#${prefix}Sequence${rowNumber}`).val();
        
        // Aggiungi solo righe con almeno codice e tipo compilati
        if (colorCode && colorType) {
            colors.push({
                code: colorCode,
                type: colorType,
                lunghezza_ordine: lunghezza,
                sequence: parseInt(colorSequence) || null,
                CH: null
            });
        }
    });
    
    return colors;
}

// Funzione per testare il paste multiplo con codici di esempio
function insertTestCodes() {
    const testCodes = [
        'RAL9005',
        'RAL9001', 
        'RAL8005',
        'RAL9004',
        'RAL9008'
    ];
    
    // Pulisci le tabelle prima
    clearBulkTable('cabin1');
    clearBulkTable('cabin2');
    
    // Simula un paste multiplo nella prima riga della Cabina 1
    const firstInput = $('#cabin1Color1');
    if (firstInput.length) {
        handleMultiLinePaste(firstInput, testCodes, 'cabin1');
        showBulkMessage('🧪 Inseriti codici di test nella Cabina 1 per dimostrare il paste semplice!', 'info');
    }
}

// Funzione per testare il paste CSV con dati completi
function insertTestCSV() {
    const testCSV = [
        'RAL8005,R,1',
        'RAL8005,E,1',
        'RAL9001,E,1', 
        'RAL9004,E,1',
        'RAL9005,R,1',
        'RAL9005,E,1',
        'RAL9008,R,1'
    ];
    
    // Pulisci le tabelle prima
    clearBulkTable('cabin1');
    clearBulkTable('cabin2');
    
    // Simula un paste CSV nella prima riga della Cabina 2
    const firstInput = $('#cabin2Color1');
    if (firstInput.length) {
        handleMultiLinePaste(firstInput, testCSV, 'cabin2');
        showBulkMessage('🧪 Inseriti dati CSV di test nella Cabina 2 per dimostrare il paste completo!', 'info');
    }
}

// === ESPORTAZIONE EXCEL ===

// Esporta i risultati dell'ottimizzazione in formato Excel
function exportToExcel() {
    if (!lastOptimizationResults) {
        alert('Nessun risultato di ottimizzazione da esportare');
        return;
    }
    
    // Prepara i dati per l'esportazione
    const exportData = prepareExportData(lastOptimizationResults);
    
    if (exportData.length === 0) {
        alert('Nessun dato da esportare');
        return;
    }
    
    // Crea il workbook
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(exportData);
    
    // Aggiungi il worksheet al workbook
    XLSX.utils.book_append_sheet(wb, ws, "Ottimizzazione Colori");
    
    // Genera il nome del file con timestamp
    const now = new Date();
    const filename = `ottimizzazione_colori_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}.xlsx`;
    
    // Scarica il file
    XLSX.writeFile(wb, filename);
}

// Prepara i dati per l'esportazione nel formato richiesto
function prepareExportData(results) {
    // Header del file Excel
    const data = [
        ['Colore', 'SeqE', 'LineaE', 'TipoE', 'SeqK', 'LineaK', 'TipoK', 'SeqF', 'LineaF', 'TipoF']
    ];
    
    // Raccoglie tutti i colori in ordine
    let allColors = [];
    
    // Funzione helper per processare i colori di una cabina
    function collectColors(colors, cabinType = '') {
        if (!colors || !Array.isArray(colors)) return;
        
        colors.forEach(color => {
            allColors.push({
                colorCode: color.color_code || color.code,
                colorType: color.color_type || color.type,
                sequence: color.final_sequence || color.sequence || '',
                cabin: cabinType
            });
        });
    }
    
    // Processa i risultati in base al formato
    if (results.cabina_1 || results.cabina_2) {
        // Risultati per cabine separate (nuova struttura)
        if (results.cabina_1 && results.cabina_1.ordered_colors) {
            collectColors(results.cabina_1.ordered_colors, 'Cabina 1');
        }
        if (results.cabina_2 && results.cabina_2.ordered_colors) {
            collectColors(results.cabina_2.ordered_colors, 'Cabina 2');
        }
    } else if (results.ordered_colors) {
        // Risultati standard (vecchia struttura)
        collectColors(results.ordered_colors);
    }
    
    if (allColors.length === 0) {
        console.warn('Nessun colore trovato nei risultati per l\'esportazione');
        return data;
    }
    
    // Raggruppa i colori per codice
    const colorGroups = {};
    
    allColors.forEach(color => {
        const colorCode = color.colorCode;
        
        if (!colorGroups[colorCode]) {
            colorGroups[colorCode] = {
                colorCode: colorCode,
                E: { sequences: [], lines: [], types: [] },
                K: { sequences: [], lines: [], types: [] },
                F: { sequences: [], lines: [], types: [] }
            };
        }
        
        const type = color.colorType;
        const sequence = color.sequence || '';
        const cabin = color.cabin || '';
        
        // Aggiungi i dati alla categoria appropriata
        if (type === 'E' || type === 'R' || type === 'RE') {
            colorGroups[colorCode].E.sequences.push(sequence);
            colorGroups[colorCode].E.lines.push(cabin);
            colorGroups[colorCode].E.types.push(type);
        } else if (type === 'K') {
            colorGroups[colorCode].K.sequences.push(sequence);
            colorGroups[colorCode].K.lines.push(cabin);
            colorGroups[colorCode].K.types.push(type);
        } else if (type === 'F') {
            colorGroups[colorCode].F.sequences.push(sequence);
            colorGroups[colorCode].F.lines.push(cabin);
            colorGroups[colorCode].F.types.push(type);
        }
    });
    
    // Converti i gruppi in righe Excel
    Object.values(colorGroups).forEach(group => {
        const row = [
            group.colorCode,
            group.E.sequences.join(', ') || '',
            group.E.lines.join(', ') || '',
            group.E.types.join(', ') || '',
            group.K.sequences.join(', ') || '',
            group.K.lines.join(', ') || '',
            group.K.types.join(', ') || '',
            group.F.sequences.join(', ') || '',
            group.F.lines.join(', ') || '',
            group.F.types.join(', ') || ''
        ];
        data.push(row);
    });
    
    return data;
}
</script>
{% endblock %}
